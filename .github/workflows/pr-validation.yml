name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [master, main]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  pr-metadata:
    name: PR Metadata Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate PR title
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;

            // Check for conventional commit format
            const pattern = /^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?: .+/;

            if (!pattern.test(title)) {
              core.setFailed(
                '‚ùå PR title must follow conventional commits format:\n' +
                'Examples:\n' +
                '  - feat: add new feature\n' +
                '  - fix(core): resolve memory leak\n' +
                '  - docs: update API documentation\n' +
                '\nValid types: feat, fix, docs, style, refactor, perf, test, chore, build, ci'
              );
            } else {
              core.info('‚úÖ PR title follows conventional commits format');
            }

      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';

            // Check minimum length
            if (body.length < 50) {
              core.warning('‚ö†Ô∏è  PR description is quite short. Consider adding more details.');
            }

            // Check for issue reference
            const hasIssueRef = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#\d+/i.test(body);
            if (!hasIssueRef) {
              core.warning('‚ö†Ô∏è  No issue reference found. Consider linking related issues.');
            }

      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;

            let size = 'XS';
            let label = 'size/XS';
            let emoji = 'üîπ';

            if (total > 1000) {
              size = 'XL';
              label = 'size/XL';
              emoji = 'üî¥';
              core.warning(`‚ö†Ô∏è  This PR is very large (${total} lines changed). Consider breaking it into smaller PRs.`);
            } else if (total > 500) {
              size = 'L';
              label = 'size/L';
              emoji = 'üü†';
            } else if (total > 100) {
              size = 'M';
              label = 'size/M';
              emoji = 'üü°';
            } else if (total > 10) {
              size = 'S';
              label = 'size/S';
              emoji = 'üü¢';
            }

            core.info(`${emoji} PR size: ${size} (${total} lines changed)`);
            core.setOutput('size', size);
            core.setOutput('label', label);

      - name: Label PR by size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            // Remove existing size labels
            const sizeLabels = labels.filter(l => l.name.startsWith('size/')).map(l => l.name);
            for (const label of sizeLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: label
              }).catch(() => {});
            }

            // Add new size label
            const newLabel = '${{ steps.pr-metadata.outputs.label }}';
            if (newLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [newLabel]
              }).catch(() => {});
            }

  test-plan-check:
    name: Test Plan Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for test changes
        id: test_check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const srcChanged = files.some(f => f.filename.startsWith('src/'));
            const testsChanged = files.some(f => f.filename.startsWith('tests/'));

            if (srcChanged && !testsChanged) {
              core.warning('‚ö†Ô∏è  Source code changed but no test files modified. Please add tests for new functionality.');
              core.setOutput('needs_tests', 'true');
            } else if (srcChanged && testsChanged) {
              core.info('‚úÖ Both source and test files modified');
              core.setOutput('needs_tests', 'false');
            } else {
              core.info('‚ÑπÔ∏è  No source code changes detected');
              core.setOutput('needs_tests', 'false');
            }

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for documentation updates
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const publicApiChanged = files.some(f =>
              f.filename.match(/src\/tinyllm\/(core|config|models)\/.*\.py$/)
            );
            const docsChanged = files.some(f =>
              f.filename.startsWith('docs/') || f.filename === 'README.md'
            );

            if (publicApiChanged && !docsChanged) {
              core.warning('‚ö†Ô∏è  Public API changed but no documentation updated. Please update docs if needed.');
            } else if (publicApiChanged && docsChanged) {
              core.info('‚úÖ Both API and documentation updated');
            }

  conflict-check:
    name: Merge Conflict Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}

          # Try to merge base branch
          if ! git merge --no-commit --no-ff origin/${{ github.base_ref }}; then
            echo "‚ùå Merge conflicts detected with base branch"
            echo "Please rebase or merge the latest changes from ${{ github.base_ref }}"
            git merge --abort
            exit 1
          else
            echo "‚úÖ No merge conflicts"
            git merge --abort
          fi

  validation-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [pr-metadata, test-plan-check, documentation-check, conflict-check]
    if: always()
    steps:
      - name: Generate summary
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'PR Metadata', result: '${{ needs.pr-metadata.result }}' },
              { name: 'Test Plan', result: '${{ needs.test-plan-check.result }}' },
              { name: 'Documentation', result: '${{ needs.documentation-check.result }}' },
              { name: 'Conflict Check', result: '${{ needs.conflict-check.result }}' }
            ];

            let summary = '## PR Validation Results\n\n';
            summary += '| Check | Status |\n';
            summary += '|-------|--------|\n';

            let allPassed = true;
            for (const job of jobs) {
              const emoji = job.result === 'success' ? '‚úÖ' : job.result === 'failure' ? '‚ùå' : '‚ö†Ô∏è';
              summary += `| ${job.name} | ${emoji} ${job.result} |\n`;
              if (job.result === 'failure') allPassed = false;
            }

            summary += '\n';
            if (allPassed) {
              summary += '‚úÖ All validation checks passed! PR is ready for review.\n';
            } else {
              summary += '‚ùå Some validation checks failed. Please address the issues above.\n';
            }

            core.summary.addRaw(summary);
            await core.summary.write();
